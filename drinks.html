<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–ù–∞–ø–æ—ó</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1100px;
      margin: 20px auto;
    }
    h1 { text-align: center; }

    #drink-form {
      display: flex;
      align-items: flex-end;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    label {
      display: flex;
      flex-direction: column;
      font-size: 14px;
    }

    input, select {
      padding: 5px 8px;
      font-size: 14px;
    }

    button {
      padding: 7px 14px;
      cursor: pointer;
      white-space: nowrap;
      height: 38px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      text-align: left;
    }

    th {
      background: #f0f0f0;
    }

    .delete-btn {
      padding: 4px 8px;
      font-size: 12px;
    }

    /* –ü–µ—Ä–µ–º–∏–∫–∞—á —Ä–µ–∂–∏–º—É –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—ñ–≤ */
    #summary-mode {
      font-size: 13px;
      margin: 10px 0 5px 0;
    }
    #summary-mode label {
      font-weight: normal;
      margin-right: 15px;
      flex-direction: row;
      align-items: center;
      gap: 4px;
      display: inline-flex;
    }

    /* –í–∏–±—ñ—Ä –¥–∞—Ç–∏ –∑–≤—ñ—Ç—É */
    #summary-date {
      font-size: 13px;
      margin: 0 0 5px 0;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    #summary-date input[type="date"] {
      padding: 3px 6px;
      font-size: 13px;
    }
    #summary-date button {
      height: auto;
      padding: 4px 10px;
      font-size: 12px;
    }

    /* ===== –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û ===== */
    .modal-bg {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
    }

    .modal {
      background: white;
      padding: 20px;
      width: 480px;
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(0,0,0,0.4);
    }

    .modal h2 {
      margin-top: 0;
      font-size: 20px;
      text-align: center;
      margin-bottom: 15px;
    }

    .modal h3 {
      margin: 12px 0 4px;
    }

    .modal-list {
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 5px;
      margin-bottom: 10px;
    }

    .modal-list div {
      display: flex;
      justify-content: space-between;
      gap: 5px;
      padding: 4px 0;
      align-items: center;
    }

    .modal-list input {
      flex: 1;
      padding: 3px 6px;
      font-size: 13px;
    }

    .modal-buttons {
      margin-top: 15px;
      display: flex;
      justify-content: space-between;
    }

    .price-editor {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
      margin-bottom: 5px;
      align-items: center;
    }

    .price-editor select,
    .price-editor input {
      padding: 3px 6px;
      font-size: 13px;
    }

    /* –ó–≤–µ–¥–µ–Ω–Ω—è */
    #summary {
      font-size: 15px;
      margin-top: 5px;
      padding: 10px;
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    #summary ul {
      padding-left: 20px;
      margin: 5px 0 15px 0;
    }

    /* –ë–ª–æ–∫ —Ä–µ–∑–µ—Ä–≤–Ω–æ—ó –∫–æ–ø—ñ—ó */
    #backup-block {
      margin-top: 15px;
      padding: 10px;
      border: 1px dashed #bbb;
      border-radius: 6px;
      font-size: 13px;
    }

    #backup-block button {
      height: auto;
      padding: 4px 10px;
      font-size: 12px;
      margin-right: 8px;
    }

    #backup-block input[type="file"] {
      font-size: 12px;
    }
  </style>
</head>
<body>

<h1>–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–ø–æ—ó–≤</h1>

<form id="drink-form">
  <label>
    –ù–∞–∑–≤–∞ –Ω–∞–ø–æ—é
    <select id="drink-name"></select>
  </label>

  <label>
    –†–æ–∑–º—ñ—Ä —Ñ—ñ–ª—ñ–∂–∞–Ω–∫–∏
    <select id="cup-size"></select>
  </label>

  <label>
    –ö—ñ–ª—å–∫—ñ—Å—Ç—å
    <input type="number" id="quantity" value="1" min="1">
  </label>

  <button type="submit">–î–æ–¥–∞—Ç–∏</button>
  <button type="button" id="clear-all">–û—á–∏—Å—Ç–∏—Ç–∏ —Å–ø–∏—Å–æ–∫</button>
  <button type="button" id="edit-lists">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Å–ø–∏—Å–∫–∏</button>
</form>

<table>
  <thead>
    <tr>
      <th>–î–∞—Ç–∞ —Ç–∞ —á–∞—Å</th>
      <th>–ù–∞–ø—ñ–π</th>
      <th>–†–æ–∑–º—ñ—Ä</th>
      <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
      <th>–¶—ñ–Ω–∞ –∑–∞ —Ñ—ñ–ª—ñ–∂–∞–Ω–∫—É</th>
      <th>–°—É–º–∞</th>
      <th>–î—ñ—ó</th>
    </tr>
  </thead>
  <tbody id="orders-body"></tbody>
</table>

<!-- –ü–µ—Ä–µ–º–∏–∫–∞—á —Ä–µ–∂–∏–º—É –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É -->
<div id="summary-mode">
  –†–µ–∂–∏–º –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É:
  <label>
    <input type="radio" name="summaryMode" value="current" checked>
    –∑–∞ –ø–æ—Ç–æ—á–Ω–∏–º–∏ —Ü—ñ–Ω–∞–º–∏
  </label>
  <label>
    <input type="radio" name="summaryMode" value="historical">
    –∑–∞ —Ü—ñ–Ω–∞–º–∏ –Ω–∞ –º–æ–º–µ–Ω—Ç –ø—Ä–æ–¥–∞–∂—É
  </label>
</div>

<!-- –í–∏–±—ñ—Ä –¥–∞—Ç–∏ –∑–≤—ñ—Ç—É -->
<div id="summary-date">
  –î–∞—Ç–∞ –∑–≤—ñ—Ç—É:
  <input type="date" id="report-date">
  <button type="button" id="report-today">–°—å–æ–≥–æ–¥–Ω—ñ</button>
</div>

<!-- –ë–ª–æ–∫ —ñ–∑ –ø—ñ–¥—Å—É–º–∫–æ–º –∑–∞ –æ–±—Ä–∞–Ω—É –¥–∞—Ç—É -->
<div id="summary"></div>

<!-- –ë–ª–æ–∫ —Ä–µ–∑–µ—Ä–≤–Ω–æ—ó –∫–æ–ø—ñ—ó -->
<div id="backup-block">
  <div style="margin-bottom:5px;">–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –¥–∞–Ω–Ω—ã—Ö:</div>
  <button type="button" id="backup-save">–ó–±–µ—Ä–µ–≥—Ç–∏ –¥–∞–Ω—ñ (—Ñ–∞–π–ª)</button>
  <label>
    –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –∑ —Ñ–∞–π–ª—É:
    <input type="file" id="backup-file" accept="application/json">
  </label>
</div>

<!-- ================= MODAL (—Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Å–ø–∏—Å–∫—ñ–≤) ================= -->
<div class="modal-bg" id="modal-bg">
  <div class="modal">
    <h2>–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Å–ø–∏—Å–∫—ñ–≤</h2>

    <h3>–ù–∞–ø–æ—ó:</h3>
    <div class="modal-list" id="drink-list"></div>
    <input type="text" id="new-drink" placeholder="–ù–æ–≤–∏–π –Ω–∞–ø—ñ–π">
    <button onclick="addToList('drink')">–î–æ–¥–∞—Ç–∏ –Ω–∞–ø—ñ–π</button>

    <h3>–†–æ–∑–º—ñ—Ä–∏ —Ñ—ñ–ª—ñ–∂–∞–Ω–æ–∫:</h3>
    <div class="modal-list" id="size-list"></div>
    <input type="text" id="new-size" placeholder="–ù–æ–≤–∏–π —Ä–æ–∑–º—ñ—Ä (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 250 –º–ª)">
    <button onclick="addToList('size')">–î–æ–¥–∞—Ç–∏ —Ä–æ–∑–º—ñ—Ä</button>

    <h3>–¶—ñ–Ω–∏ (–∑–∞ –æ–¥–Ω—É —Ñ—ñ–ª—ñ–∂–∞–Ω–∫—É):</h3>
    <div class="modal-list" id="price-list"></div>

    <div class="price-editor">
      <select id="price-drink"></select>
      <select id="price-size"></select>
      <input type="number" id="price-value" min="0" step="0.01" placeholder="–¶—ñ–Ω–∞">
      <button type="button" onclick="addOrUpdatePrice()">–ó–±–µ—Ä–µ–≥—Ç–∏ —Ü—ñ–Ω—É</button>
    </div>

    <div class="modal-buttons">
      <button onclick="closeModal()">–ó–∞–∫—Ä–∏—Ç–∏</button>
      <button onclick="saveLists()">–ó–±–µ—Ä–µ–≥—Ç–∏ –≤—Å–µ</button>
    </div>
  </div>
</div>

<script>
  const STORAGE_DRINKS = "drinkList";
  const STORAGE_SIZES  = "sizeList";
  const STORAGE_ORDERS = "drinkOrders";
  const STORAGE_PRICES = "priceList";

  const drinkSelect = document.getElementById('drink-name');
  const sizeSelect  = document.getElementById('cup-size');

  const modalBg      = document.getElementById('modal-bg');
  const drinkListDiv = document.getElementById('drink-list');
  const sizeListDiv  = document.getElementById('size-list');
  const priceListDiv = document.getElementById('price-list');
  const summaryDiv   = document.getElementById('summary');

  const priceDrinkSelect = document.getElementById('price-drink');
  const priceSizeSelect  = document.getElementById('price-size');
  const priceValueInput  = document.getElementById('price-value');

  const reportDateInput  = document.getElementById('report-date');
  const reportTodayBtn   = document.getElementById('report-today');

  const backupSaveBtn    = document.getElementById('backup-save');
  const backupFileInput  = document.getElementById('backup-file');

  let drinks = [];
  let sizes  = [];
  let prices = []; // {drink, size, price}
  let orders = [];
  let drinksBeforeEdit = [];
  let summaryMode = 'current'; // 'current' | 'historical'

  /* ===== –î–û–ü–û–ú–û–ñ–ù–Ü –§–£–ù–ö–¶–Ü–á –î–ê–¢–ò ===== */

  function getTodayKey() {
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const dd = String(now.getDate()).padStart(2, '0');
    return `${dd}.${mm}.${yyyy}`;
  }

  function getTodayISO() {
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, '0');
    const dd = String(now.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function isoToKey(iso) {
    if (!iso || !iso.includes('-')) return getTodayKey();
    const [y, m, d] = iso.split('-');
    return `${d}.${m}.${y}`;
  }

  function getDayFromDateString(dateStr) {
    if (!dateStr) return "";
    return dateStr.split(" ")[0] || "";
  }

  function getSelectedReportKey() {
    const val = reportDateInput.value;
    if (!val) return getTodayKey();
    return isoToKey(val);
  }

  /* ================== LISTS ================== */

  function loadLists() {
    drinks = JSON.parse(localStorage.getItem(STORAGE_DRINKS) || '["–ê–º–µ—Ä–∏–∫–∞–Ω–æ","–ö–∞–ø—É—á—ñ–Ω–æ","–õ–∞—Ç—Ç–µ"]');
    sizes  = JSON.parse(localStorage.getItem(STORAGE_SIZES)  || '["200 –º–ª","250 –º–ª","300 –º–ª"]');
    prices = JSON.parse(localStorage.getItem(STORAGE_PRICES) || "[]");
  }

  function saveLists() {
    applyDrinkRenames(drinksBeforeEdit, drinks);

    localStorage.setItem(STORAGE_DRINKS, JSON.stringify(drinks));
    localStorage.setItem(STORAGE_SIZES,  JSON.stringify(sizes));
    localStorage.setItem(STORAGE_PRICES, JSON.stringify(prices));

    updateSelects();
    renderOrders();
    closeModal();
  }

  function updateSelects() {
    drinkSelect.innerHTML = drinks.map(d => `<option>${d}</option>`).join("");
    sizeSelect.innerHTML  = sizes.map(s => `<option>${s}</option>`).join("");

    priceDrinkSelect.innerHTML = drinks.map(d => `<option>${d}</option>`).join("");
    priceSizeSelect.innerHTML  = sizes.map(s => `<option>${s}</option>`).join("");
  }

  function openModal() {
    drinksBeforeEdit = [...drinks];
    renderModalLists();
    modalBg.style.display = "flex";
  }

  function closeModal() {
    modalBg.style.display = "none";
  }

  function renderModalLists() {
    drinkListDiv.innerHTML = drinks
      .map((d, i) => `
        <div>
          <input type="text" value="${d}" data-index="${i}" class="drink-edit-input">
          <button onclick="removeFromList('drink',${i})">X</button>
        </div>
      `)
      .join("");

    sizeListDiv.innerHTML = sizes
      .map((s, i) => `
        <div>
          <span>${s}</span>
          <button onclick="removeFromList('size',${i})">X</button>
        </div>
      `)
      .join("");

    priceListDiv.innerHTML = prices
      .map((p, i) => `
        <div>
          <span>${p.drink} ‚Äî ${p.size}: ${p.price}</span>
          <button onclick="removePrice(${i})">X</button>
        </div>
      `)
      .join("");
  }

  function addToList(type) {
    if (type === "drink") {
      const val = document.getElementById('new-drink').value.trim();
      if (val) drinks.push(val);
      document.getElementById('new-drink').value = "";
    } else {
      const val = document.getElementById('new-size').value.trim();
      if (val) sizes.push(val);
      document.getElementById('new-size').value = "";
    }
    renderModalLists();
    updateSelects();
  }

  // üîí –ù–ï –ú–û–ñ–ù–ê –í–ò–î–ê–õ–ò–¢–ò, –Ø–ö–©–û –í–ò–ö–û–†–ò–°–¢–û–í–£–Ñ–¢–¨–°–Ø –£ –ó–ê–ü–ò–°–ê–•
  function removeFromList(type, index) {
    if (type === "drink") {
      const removedName = drinks[index];
      const used = orders.some(o => o.name === removedName);
      if (used) {
        alert("–ù–µ –º–æ–∂–Ω–∞ –≤–∏–¥–∞–ª–∏—Ç–∏ –Ω–∞–ø—ñ–π, —è–∫–∏–π –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —É –∑–∞–ø–∏—Å–∞—Ö.");
        return;
      }
      drinks.splice(index, 1);
      prices = prices.filter(p => p.drink !== removedName);
    } else {
      const removedSize = sizes[index];
      const used = orders.some(o => o.size === removedSize);
      if (used) {
        alert("–ù–µ –º–æ–∂–Ω–∞ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ä–æ–∑–º—ñ—Ä —Ñ—ñ–ª—ñ–∂–∞–Ω–∫–∏, —è–∫–∏–π –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —É –∑–∞–ø–∏—Å–∞—Ö.");
        return;
      }
      sizes.splice(index, 1);
      prices = prices.filter(p => p.size !== removedSize);
    }
    renderModalLists();
    updateSelects();
  }

  // üîí –ù–ï –ú–û–ñ–ù–ê –ó–ê–õ–ò–®–ò–¢–ò –ü–û–†–û–ñ–ù–Ü –ù–ê–ó–í–ê –ù–ê–ü–û–á
  drinkListDiv.addEventListener('input', (e) => {
    if (!e.target.classList.contains('drink-edit-input')) return;
    const idx = Number(e.target.dataset.index);
    if (Number.isNaN(idx)) return;

    const newValTrimmed = e.target.value.trim();

    if (newValTrimmed === "") {
      alert("–ù–∞–∑–≤–∞ –Ω–∞–ø–æ—é –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—å–æ—é.");
      // –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –≤—ñ–∑—É–∞–ª—å–Ω–æ —Å—Ç–∞—Ä–µ –∑–Ω–∞—á–µ–Ω–Ω—è –∑ –º–∞—Å–∏–≤—É
      e.target.value = drinks[idx] ?? "";
      return;
    }

    // –∑–∞–ø–∏—Å—É—î–º–æ –Ω–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è, —è–∫—â–æ –≤–æ–Ω–æ –Ω–µ –ø–æ—Ä–æ–∂–Ω—î
    drinks[idx] = e.target.value;
  });

  /* ===== –¶–Ü–ù–ò ===== */

  function addOrUpdatePrice() {
    const drink = priceDrinkSelect.value;
    const size  = priceSizeSelect.value;
    const val   = parseFloat(String(priceValueInput.value).replace(',', '.'));

    if (!drink || !size || isNaN(val) || val < 0) {
      alert("–í–∫–∞–∂—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É —Ü—ñ–Ω—É.");
      return;
    }

    const existing = prices.find(p => p.drink === drink && p.size === size);
    if (existing) existing.price = val;
    else prices.push({ drink, size, price: val });

    priceValueInput.value = "";
    renderModalLists();
  }

  function removePrice(i) {
    prices.splice(i, 1);
    renderModalLists();
  }

  function getPriceFor(drink, size) {
    const p = prices.find(p => p.drink === drink && p.size === size);
    return p ? p.price : null;
  }

  /* ================= ORDERS LOGIC ================= */

  function loadOrders() {
    orders = JSON.parse(localStorage.getItem(STORAGE_ORDERS) || "[]");
    renderOrders();
  }

  function saveOrders() {
    localStorage.setItem(STORAGE_ORDERS, JSON.stringify(orders));
  }

  function renderOrders() {
    const tbody = document.getElementById('orders-body');
    tbody.innerHTML = orders.map((o, i) => {
      const qty   = Number(o.q ?? o.quantity ?? 0) || 0;

      // –î–ª—è —Ç–∞–±–ª–∏—Ü—ñ: —è–∫—â–æ —î –∑–±–µ—Ä–µ–∂–µ–Ω–∞ —Ü—ñ–Ω–∞ - –±–µ—Ä–µ–º–æ —ó—ó, —ñ–Ω–∞–∫—à–µ –±–µ—Ä–µ–º–æ –ø–æ—Ç–æ—á–Ω—É
      let price = Number(o.price ?? 0);
      if (!price) {
        const p = getPriceFor(o.name, o.size);
        price = p ? Number(p) : 0;
      }

      const total = price * qty;

      return `
        <tr>
          <td>${o.date || ""}</td>
          <td>${o.name || ""}</td>
          <td>${o.size || ""}</td>
          <td>${qty}</td>
          <td>${price.toFixed(2)}</td>
          <td>${total.toFixed(2)}</td>
          <td><button class="delete-btn" onclick="delOrder(${i})">–í–∏–¥–∞–ª–∏—Ç–∏</button></td>
        </tr>
      `;
    }).join("");
    renderSummary();
  }

  function delOrder(i) {
    orders.splice(i, 1);
    saveOrders();
    renderOrders();
  }

  function addOrder(event) {
    event.preventDefault();
    const name = drinkSelect.value;
    const size = sizeSelect.value;
    const q = parseInt(document.getElementById('quantity').value, 10);
    if (!q || q <= 0) return;

    const price = getPriceFor(name, size);
    if (price === null) {
      alert("–î–ª—è —Ü—ñ—î—ó –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—ó –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Ü—ñ–Ω–∏. –ó–∞–¥–∞–π—Ç–µ —ó—ó —É —Ä–µ–¥–∞–∫—Ç–æ—Ä—ñ —Å–ø–∏—Å–∫—ñ–≤.");
      return;
    }

    const now = new Date();
    const today = getTodayKey();
    const dt = today + " " + now.toLocaleTimeString();

    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ü—ñ–Ω—É –Ω–∞ –º–æ–º–µ–Ω—Ç –ø—Ä–æ–¥–∞–∂—É (–¥–ª—è —ñ—Å—Ç–æ—Ä–∏—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É)
    orders.unshift({ date: dt, day: today, name, size, q, price });
    saveOrders();
    renderOrders();
  }

  function clearAll() {
    if (!confirm("–û—á–∏—Å—Ç–∏—Ç–∏ –≤–µ—Å—å —Å–ø–∏—Å–æ–∫?")) return;
    orders = [];
    saveOrders();
    renderOrders();
  }

  /* ===== –ü–µ—Ä–µ–π–º–µ–Ω—É–≤–∞–Ω–Ω—è –Ω–∞–ø–æ—ó–≤ ===== */

  function applyDrinkRenames(oldList, newList) {
    const renameMap = {};
    const len = Math.min(oldList.length, newList.length);

    for (let i = 0; i < len; i++) {
      const oldName = oldList[i];
      const newName = newList[i];
      if (oldName !== newName) renameMap[oldName] = newName;
    }

    if (Object.keys(renameMap).length === 0) return;

    orders = orders.map(o => {
      if (renameMap[o.name]) o.name = renameMap[o.name];
      return o;
    });

    prices = prices.map(p => {
      if (renameMap[p.drink]) p.drink = renameMap[p.drink];
      return p;
    });

    saveOrders();
    localStorage.setItem(STORAGE_PRICES, JSON.stringify(prices));
  }

  /* ============== –ó–í–ï–î–ï–ù–ù–Ø –ó–ê –û–ë–†–ê–ù–£ –î–ê–¢–£ ============== */

  function renderSummary() {
    const dayKey = getSelectedReportKey(); // DD.MM.YYYY

    const combos = {}; // key -> {qty, sum}

    orders.forEach(o => {
      const day = o.day || getDayFromDateString(o.date);
      if (day !== dayKey) return;

      const name = o.name || "‚Äî";
      const size = o.size || "‚Äî";
      const qty  = Number(o.q ?? 0) || 0;
      if (!qty) return;

      let price = 0;

      if (summaryMode === 'historical') {
        // –ë–µ—Ä–µ–º–æ —Ü—ñ–Ω—É —ñ–∑ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (—ñ—Å—Ç–æ—Ä–∏—á–Ω–∞)
        price = Number(o.price ?? 0) || 0;
        if (!price) {
          const pObj = prices.find(p => p.drink === name && p.size === size);
          if (pObj) price = Number(pObj.price) || 0;
        }
      } else {
        // –ë–µ—Ä–µ–º–æ —Ü—ñ–Ω—É —ñ–∑ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–ø–∏—Å–∫—É —Ü—ñ–Ω
        const pObj = prices.find(p => p.drink === name && p.size === size);
        price = pObj ? Number(pObj.price) || 0 : 0;
      }

      const key = name + " | " + size;

      if (!combos[key]) combos[key] = { qty: 0, sum: 0 };

      combos[key].qty += qty;
      combos[key].sum += qty * price;
    });

    const keys = Object.keys(combos);
    if (keys.length === 0) {
      summaryDiv.textContent = `–ó–∞ –≤–∏–±—Ä–∞–Ω—É –¥–∞—Ç—É (${dayKey}) —â–µ –Ω–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤.`;
      return;
    }

    const modeText =
      summaryMode === 'current'
        ? '–∑–∞ –ü–û–¢–û–ß–ù–ò–ú–ò —Ü—ñ–Ω–∞–º–∏'
        : '–∑–∞ —Ü—ñ–Ω–∞–º–∏ –Ω–∞ –º–æ–º–µ–Ω—Ç –ø—Ä–æ–¥–∞–∂—É';

    let totalMoney = 0;

    let html = `<strong>–†–∞–∑–æ–º –∑–∞ ${dayKey} (${modeText}):</strong><ul>`;

    for (const key of keys) {
      const [name, size] = key.split(" | ");
      const { qty, sum } = combos[key];
      totalMoney += sum;

      html += `<li>${name} ‚Äî ${size}: ${qty} —à—Ç = ${sum.toFixed(2)}</li>`;
    }

    html += `</ul><strong>–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞: ${totalMoney.toFixed(2)}</strong>`;
    summaryDiv.innerHTML = html;
  }

  /* ============== –†–ï–ó–ï–†–í–ù–ê –ö–û–ü–Ü–Ø (–ï–ö–°–ü–û–†–¢/–Ü–ú–ü–û–†–¢) ============== */

  function exportData() {
    const data = {
      drinks,
      sizes,
      prices,
      orders,
    };
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: "application/json" });
    const url  = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "coffee-data-backup.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function importData(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);

        if (!data || typeof data !== "object") {
          throw new Error("Bad format");
        }

        if (Array.isArray(data.drinks)) drinks = data.drinks;
        if (Array.isArray(data.sizes))  sizes  = data.sizes;
        if (Array.isArray(data.prices)) prices = data.prices;
        if (Array.isArray(data.orders)) orders = data.orders;

        localStorage.setItem(STORAGE_DRINKS, JSON.stringify(drinks));
        localStorage.setItem(STORAGE_SIZES,  JSON.stringify(sizes));
        localStorage.setItem(STORAGE_PRICES, JSON.stringify(prices));
        localStorage.setItem(STORAGE_ORDERS, JSON.stringify(orders));

        updateSelects();
        renderOrders();
        alert("–î–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω—ñ.");
      } catch (err) {
        console.error(err);
        alert("–ù–µ–º–æ–∂–ª–∏–≤–æ —ñ–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ —Ñ–∞–π–ª. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —â–æ —Ü–µ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π backup-—Ñ–∞–π–ª.");
      } finally {
        event.target.value = "";
      }
    };
    reader.readAsText(file, "utf-8");
  }

  /* ================= INIT ================= */
  loadLists();
  updateSelects();
  loadOrders();

  // –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ —Å—å–æ–≥–æ–¥–Ω—ñ—à–Ω—é –¥–∞—Ç—É —É –∫–∞–ª–µ–Ω–¥–∞—Ä–∏–∫
  reportDateInput.value = getTodayISO();

  // –æ–±—Ä–æ–±–Ω–∏–∫ –ø–µ—Ä–µ–º–∏–∫–∞—á–∞ —Ä–µ–∂–∏–º—É
  document.querySelectorAll('input[name="summaryMode"]').forEach(input => {
    input.addEventListener('change', () => {
      summaryMode = input.value; // 'current' –∞–±–æ 'historical'
      renderSummary();
    });
  });

  // –∑–º—ñ–Ω–∞ –¥–∞—Ç–∏ –∑–≤—ñ—Ç—É
  reportDateInput.addEventListener('change', () => {
    renderSummary();
  });

  // –∫–Ω–æ–ø–∫–∞ "–°—å–æ–≥–æ–¥–Ω—ñ"
  reportTodayBtn.addEventListener('click', () => {
    reportDateInput.value = getTodayISO();
    renderSummary();
  });

  // —Ä–µ–∑–µ—Ä–≤–Ω–∞ –∫–æ–ø—ñ—è - –µ–∫—Å–ø–æ—Ä—Ç / —ñ–º–ø–æ—Ä—Ç
  backupSaveBtn.addEventListener('click', exportData);
  backupFileInput.addEventListener('change', importData);

  document.getElementById("drink-form").addEventListener("submit", addOrder);
  document.getElementById("clear-all").addEventListener("click", clearAll);
  document.getElementById("edit-lists").addEventListener("click", openModal);
</script>

</body>
</html>
